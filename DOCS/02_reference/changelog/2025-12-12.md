# Changelog â€” 2025-12-12

**Sample Size Binning System, Trend Analysis System Extension (Feature Selection), Cohort-Aware Reproducibility System, RESULTS Directory Organization, Integrated Backups, Enhanced Metadata**

For a quick overview, see the [root changelog](../../../../CHANGELOG.md).  
For other dates, see the [changelog index](README.md).

---

## Added

### Sample Size Binning System

**Directory Organization by Sample Size Bins**
- **Enhancement**: Implemented audit-grade sample size binning for RESULTS directory organization
- **Structure**: `RESULTS/sample_25k-50k/{run_name}/` instead of exact `N_effective`
- **Bins**: 9 bins (0-5k, 5k-10k, 10k-25k, 25k-50k, 50k-100k, 100k-250k, 250k-500k, 500k-1M, 1M+)
- **Boundaries**: EXCLUSIVE upper bounds (`bin_min <= N_effective < bin_max`) - unambiguous binning
- **Versioning**: `sample_bin_v1` stored in metadata for backward compatibility
- **Early Estimation**: Automatically estimates `N_effective` from data files or existing metadata during initialization
- **Metadata**: Bin info stored in `metadata.json`: `bin_name`, `bin_min`, `bin_max`, `binning_scheme_version`
- **Files**:
  - `TRAINING/orchestration/intelligent_trainer.py` - Added `_get_sample_size_bin()` and `_estimate_n_effective_early()`
  - `TRAINING/utils/reproducibility_tracker.py` - Added `_compute_sample_size_bin()` static method

**Benefits**:
- Easy comparison of runs with similar sample sizes (e.g., all ~25k runs in `sample_25k-50k/`)
- Trend analysis friendly: Series won't fragment when `N_effective` jitters slightly
- Cleaner structure: Only 9 top-level directories instead of hundreds
- Audit-grade: Boundaries are deterministic, versioned, and stored in metadata
- Trend series stability: Bin NOT included in series keys (uses stable identity: cohort_id, stage, target)

### Trend Analysis System Extension

**Feature Selection Integration**
- **Enhancement**: Extended trend analysis system to feature selection (single symbol + aggregated) and cross-sectional feature ranking
- **Coverage**: Trend analysis now integrated into:
  - Target Ranking (`TRAINING/ranking/predictability/model_evaluation.py`)
  - Feature Selection - Single symbol + aggregated (`TRAINING/ranking/feature_selector.py`)
  - Cross-Sectional Feature Ranking (`TRAINING/ranking/cross_sectional_feature_ranker.py`)
- **API**: All stages use the same `log_run()` API with `RunContext` and include trend analysis automatically
- **Metrics**: Tracks `n_selected`, `n_features_selected`, `mean_consensus`, `std_consensus` for feature selection
- **CS Metrics**: Tracks `cs_importance_score`, `n_features_evaluated` for cross-sectional ranking
- **Metadata**: Trend metadata stored in `metadata.json` (same format as target ranking)
- **Fallback**: Gracefully falls back to legacy `log_comparison()` API if `RunContext` unavailable
- **Files**: 
  - `TRAINING/ranking/feature_selector.py` - Updated to use `log_run()` API with trend analysis
  - `TRAINING/ranking/cross_sectional_feature_ranker.py` - Added reproducibility tracking with trend analysis

### Files Modified

#### Feature Selection
- `TRAINING/ranking/feature_selector.py`
  - Updated reproducibility tracking to use new `log_run()` API with `RunContext`
  - Integrated trend analysis (same infrastructure as target ranking)
  - Falls back to legacy `log_comparison()` API if `RunContext` unavailable
  - Tracks metrics: `n_selected`, `n_features_selected`, `mean_consensus`, `std_consensus`

#### Cross-Sectional Feature Ranking
- `TRAINING/ranking/cross_sectional_feature_ranker.py`
  - Added `output_dir` parameter to `compute_cross_sectional_importance()`
  - Integrated reproducibility tracking with `log_run()` API and trend analysis
  - Tracks CS-specific metrics: `cs_importance_score`, `n_features_evaluated`
  - Passes `output_dir` from `feature_selector.py` for tracking

### Features

- **Trend Analysis**: Both single-symbol and cross-sectional feature selection now compute trends automatically
- **Metadata Storage**: Trend metadata stored in `metadata.json` (same format as target ranking)
- **Skip Logging**: Explicit skip reasons when insufficient runs (no silent failures)
- **Audit Reports**: Audit violations/warnings logged for feature selection runs
- **Graceful Fallback**: Falls back to legacy API if `RunContext` unavailable

### Coverage

Trend analysis is now integrated into:
- âœ… Target Ranking (`TRAINING/ranking/predictability/model_evaluation.py`)
- âœ… Feature Selection - Single symbol + aggregated (`TRAINING/ranking/feature_selector.py`)
- âœ… Cross-Sectional Feature Ranking (`TRAINING/ranking/cross_sectional_feature_ranker.py`)

All stages use the same `log_run()` API with `RunContext` and include trend analysis automatically.

### Documentation

- Updated `CHANGELOG.md` with Trend Analysis System highlight
- Updated `DOCS/03_technical/implementation/TREND_ANALYZER_VERIFICATION.md` to include feature selection coverage
- Updated `DOCS/INDEX.md` with trend analyzer verification guide reference

### Testing

To verify:
1. Run feature selection multiple times (same target, same cohort)
2. Check logs for trend messages: `ðŸ“ˆ Trend (n_selected): slope=.../day`
3. Check `metadata.json` for `trend` sections
4. Verify `TREND_REPORT.json` includes feature selection series

## Added (2025-12-12)

### Active Sanitization (Ghost Buster)

**Proactive Feature Quarantine System**
- **Enhancement**: Implemented active sanitization to automatically quarantine features with excessive lookback before training starts
- **Purpose**: Prevents "ghost feature" discrepancies where audit and auto-fix see different lookback values
- **Problem Solved**: Previously, daily/24h features (1440m lookback) caused conflicts:
  - Audit enforcer detected 1440m (from daily feature)
  - Auto-fix resolver calculated 1000m (from sma_200)
  - Result: `AUDIT VIOLATION: purge_minutes (1010) < feature_lookback_max_minutes (1440)`
- **Solution**: Active sanitization quarantines problematic features BEFORE lookback computation, ensuring both audit and auto-fix see the same values

**Implementation:**
- **New Module**: `TRAINING/utils/feature_sanitizer.py`
  - `auto_quarantine_long_lookback_features()`: Scans features and quarantines those with excessive lookback
  - `quarantine_by_pattern()`: Optional pattern-based quarantine (more aggressive)
- **Integration**: Integrated into `filter_features_for_target()` in `TRAINING/utils/leakage_filtering.py`
  - Runs after all other filtering (registry, patterns, etc.)
  - Automatically quarantines problematic features before training starts
- **Configuration**: `CONFIG/training_config/safety_config.yaml`
  ```yaml
  active_sanitization:
    enabled: true  # Enable active sanitization
    max_safe_lookback_minutes: 240.0  # Default: 4 hours
    pattern_quarantine:
      enabled: false  # Optional pattern-based quarantine
      patterns: []
  ```

**How It Works:**
1. After all other filtering, sanitizer scans remaining features
2. Computes lookback for each feature using same logic as auto-fix
3. Quarantines features with lookback > `max_safe_lookback_minutes` (default: 240m)
4. Logs what was quarantined and why
5. Returns only safe features for training

**Expected Behavior:**
- Daily/24h features (1440m lookback) quarantined before lookback computation
- Auto-fix sees 1000m (from sma_200) instead of 1440m
- Audit sees 1000m (same as auto-fix)
- Purge auto-adjusts to 1010m (1000 * 1.01)
- No more "ghost feature" discrepancies

**Files:**
- `TRAINING/utils/feature_sanitizer.py` - New module with quarantine logic
- `TRAINING/utils/leakage_filtering.py` - Integration into feature filtering pipeline
- `CONFIG/training_config/safety_config.yaml` - Configuration settings

**Documentation:**
- See [Active Sanitization Guide](../../03_technical/implementation/ACTIVE_SANITIZATION.md) for detailed documentation

## Fixed (2025-12-12)

### Reproducibility Tracking Bug Fixes

**Critical Bug Fixes**
- **Fixed `ctx` NameError in reproducibility tracker** (`TRAINING/utils/reproducibility_tracker.py:862`)
  - **Issue**: `NameError: name 'ctx' is not defined` when saving metadata for TARGET_RANKING
  - **Impact**: Prevented `metadata.json` and `metrics.json` from being written (86 failures in `stats.json`)
  - **Fix**: Changed to use `additional_data.get('view')` instead of `getattr(ctx, 'view', None)`
  - **Result**: Metadata files now write correctly for all runs

- **Fixed feature importances save path** (`TRAINING/ranking/predictability/model_evaluation.py`)
  - **Issue**: Feature importances saved under `CROSS_SECTIONAL` even for `SYMBOL_SPECIFIC` runs
  - **Fix**: Added `view` parameter to `_save_feature_importances()` and updated directory structure
  - **Result**: Feature importances now saved under correct view directory: `target_rankings/feature_importances/{target}/{view}/{symbol?}/`

- **Fixed perfect CV detection false positive** (`TRAINING/ranking/predictability/model_evaluation.py`)
  - **Issue**: Triggered on training scores (0.9999) instead of actual CV scores (0.687)
  - **Fix**: Changed to use `primary_scores` (from `cross_val_score`) as primary source, with explicit overwrite of training metrics with CV scores
  - **Result**: Perfect CV detection now only triggers on actual validation CV scores â‰¥ 99%

- **Added missing metadata diagnostic** (`TRAINING/utils/reproducibility_tracker.py`)
  - **Enhancement**: Warns when `metadata.json` or `metrics.json` are missing but `audit_report.json` exists
  - **Purpose**: Detects partial writes from previous bugs
  - **Result**: Better visibility into metadata completeness

**Files Modified**:
- `TRAINING/utils/reproducibility_tracker.py` - Fixed `ctx` NameError, added metadata diagnostic
- `TRAINING/ranking/predictability/model_evaluation.py` - Fixed feature importances path, fixed CV score detection, updated `_compute_and_store_metrics()` to store CV scores correctly

**Impact**:
- All new runs will have complete metadata files
- Feature importances saved under correct view directories
- Perfect CV detection now accurate (no false positives)
- Existing runs from before fix are missing metadata (documented in `METADATA_MISSING_README.md`)

### Related

- See [Trend Analyzer Verification Guide](../03_technical/implementation/TREND_ANALYZER_VERIFICATION.md)
- See [Cohort-Aware Reproducibility Guide](../03_technical/implementation/COHORT_AWARE_REPRODUCIBILITY.md)
