# Safety and Numerical Stability Configuration
# Settings for numerical guards, clipping, and safety thresholds

safety:
  # Feature Clipping
  feature_clipping:
    enabled: true
    clip_value: 1000.0  # Clip features to [-1000, 1000]
    log_clipped: false  # Log when features are clipped
  
  # Target Capping
  target_capping:
    enabled: true
    cap_sigma: 15.0  # Cap targets using 15 MAD (median absolute deviation)
    log_capped: false  # Log when targets are capped
  
  # Numerical Stability
  numerical:
    safe_exp_bounds:
      lo: -40.0  # Lower bound for safe exponential
      hi: 40.0  # Upper bound for safe exponential
    
    numpy_error_handling:
      over: "warn"  # Overflow handling: "warn", "raise", "ignore"
      invalid: "warn"  # Invalid value handling
      divide: "warn"  # Division by zero handling
      under: "ignore"  # Underflow handling
  
  # Gradient Clipping
  gradient_clipping:
    enabled: true
    clipnorm: 1.0  # Gradient norm clipping (TensorFlow/Keras)
    max_norm: 1.0  # Maximum gradient norm (PyTorch)
  
  # Model Output Validation
  validation:
    check_predictions: true  # Check predictions for NaN/Inf
    check_gradients: false  # Check gradients for NaN/Inf (expensive)
    log_anomalies: true  # Log when anomalies are detected
  
  # Safety Guards
  guards:
    min_history_bars: 120  # Minimum history bars before feature use
    max_na_fraction: 0.05  # Maximum NaN fraction (5%)
    hold_on_nan: true  # Return HOLD action on NaN in predictions
  
  # Leakage Detection & Auto-Fix Thresholds
  leakage_detection:
    # Auto-fixer triggers when scores exceed these thresholds
    auto_fix_thresholds:
      cv_score: 0.99  # Cross-validation score threshold (0.99 = 99%)
      training_accuracy: 0.999  # Training accuracy threshold (0.999 = 99.9%)
      training_r2: 0.999  # Training RÂ² threshold for regression (0.999 = 99.9%)
      perfect_correlation: 0.999  # Perfect correlation threshold (0.999 = 99.9%)
    
    # Minimum confidence for auto-fixer to apply fixes (0.0 to 1.0)
    auto_fix_min_confidence: 0.8  # Only auto-fix leaks with >= 80% confidence
    
    # Enable/disable auto-fixer
    auto_fix_enabled: true  # Set to false to disable automatic leakage fixing

